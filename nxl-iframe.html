
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Nexus Luma AI ‚Äî Iframe Widget</title>
  <style>
    :root { color-scheme: dark; }
    body { margin: 0; font-family: Inter, system-ui, sans-serif; background: transparent; }
    .shell { width: 360px; max-width: 92vw; border-radius: 18px; border: 1px solid rgba(255,255,255,.12);
             background: linear-gradient( to bottom right, rgba(18,18,26,.88), rgba(10,10,14,.88) ); padding: 10px; }
    .row { display: flex; gap: 8px; align-items: center; }
    .mic { width: 38px; height: 38px; display: grid; place-items: center; border: 1px solid rgba(255,255,255,.14); border-radius: 10px; cursor: pointer; }
    .status { font-size: 12px; color: #cfcfe8; }
    .chat { height: 180px; overflow: auto; padding: 8px; border-radius: 12px; background: rgba(255,255,255,.04); border: 1px solid rgba(255,255,255,.08); margin-top: 10px; }
    .composer { display: flex; gap: 6px; margin-top: 8px; }
    .composer input { flex:1; min-width:0; background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.14); color: #eaeaea; border-radius: 10px; padding: 8px 10px; font-size: 13px; }
    .btn { appearance: none; background: transparent; color: #eaeaea; border: 1px solid rgba(255,255,255,.14); border-radius: 10px; padding: 8px 10px; font-size: 12px; cursor: pointer; white-space: nowrap; }
  </style>
  <script>
    const search = new URLSearchParams(location.search);
    const PUBLIC_KEY = search.get('publicKey') || '';
    const ASSISTANT_ID = search.get('assistantId') || '';
    const HOST_ORIGIN = search.get('host') || '*';

    function post(type, payload){ parent.postMessage({ source: 'NXL_IFRAME', type, payload }, HOST_ORIGIN); }

    function ensureVapi(){
      return new Promise((resolve, reject)=>{
        if (window.Vapi) return resolve();
        const s = document.createElement('script');
        s.src = "https://cdn.jsdelivr.net/npm/@vapi-ai/web@latest/dist/vapi.js";
        s.onload = resolve;
        s.onerror = ()=> reject(new Error('Failed to load Vapi'));
        document.head.appendChild(s);
      });
    }

    let vapi = null;
    let listening = false;

    async function toggleMic(){
      if(!vapi) return;
      if(!listening){
        try{
          await navigator.mediaDevices.getUserMedia({audio:true});
          if (vapi.start) await vapi.start(ASSISTANT_ID);
          else if (vapi.connectToAssistant) await vapi.connectToAssistant(ASSISTANT_ID);
          listening = true;
          document.querySelector('.mic').classList.add('on');
          document.querySelector('.status').textContent = 'Listening‚Ä¶';
          post('state', {listening:true});
        }catch(e){
          document.querySelector('.status').textContent = 'Mic blocked';
          post('error', {kind:'mic_denied'});
        }
      } else {
        try{
          if (vapi.stop) await vapi.stop();
          listening = false;
          document.querySelector('.mic').classList.remove('on');
          document.querySelector('.status').textContent = 'Idle';
          post('state', {listening:false});
        }catch(e){}
      }
    }

    addEventListener('message', (e)=>{
      const {data} = e;
      if (!data || data.source !== 'NXL_HOST') return;
      if (data.type === 'open') { /* could animate */ }
      if (data.type === 'close') { /* could animate */ }
      if (data.type === 'sendText' && vapi && vapi.sendText) {
        vapi.sendText(String(data.payload || ''));
      }
    });

    ensureVapi().then(()=>{
      vapi = new Vapi(PUBLIC_KEY);
      post('ready', {ok:true, version:'1.0.0'});
    }).catch(()=>{
      post('error', {kind:'sdk_load_failed'});
    });
  </script>
</head>
<body>
  <div class="shell">
    <div class="row">
      <div class="mic" onclick="toggleMic()">üéôÔ∏è</div>
      <div class="status">Idle</div>
      <button class="btn" onclick="parent.postMessage({source:'NXL_IFRAME',type:'close'}, HOST_ORIGIN)">Close</button>
    </div>
    <div class="chat" aria-live="polite"></div>
    <div class="composer">
      <input id="t" placeholder="Type a message‚Ä¶"/>
      <button class="btn" onclick="parent.postMessage({source:'NXL_IFRAME',type:'sendText', payload: document.getElementById('t').value}, HOST_ORIGIN)">Send</button>
    </div>
  </div>
</body>
</html>
